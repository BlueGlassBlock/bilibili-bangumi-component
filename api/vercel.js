const isMock = false
function p(s){return Object.entries(s).filter(([,t])=>!!t).map(([t,e])=>`${t}=${e}`).join("&")}function b(s){return Object.fromEntries(Array.from(s.searchParams.entries()).filter(([,t])=>!!t))}function c(s){let t=s.toString();if(t.length<5)return t;if(t.length<9){let o=t.slice(0,-3),n=o.length,i=o[n-1]==="0"?"":`.${o[n-1]}`;return`${o.slice(0,n-1)}${i}\u4E07`}let e=t.slice(0,-7),r=e.length,a=e[r-1]==="0"?"":`.${e[r-1]}`;return`${e.slice(0,r-1)}${a}\u4EBF`}async function g(s,t){let{collectionType:e="0",uid:r,pageNumber:a="1",pageSize:o="10"}=s,n=r??t?.BILIBILI;if(!n)return Response.json({code:400,message:"uid is required",data:{}},{status:400});let i=p({type:1,follow_status:e,pn:a,ps:o,vmid:n}),u=await fetch(`https://api.bilibili.com/x/space/bangumi/follow/list?${i}`),l=await u.json();return u.ok?Response.json({code:200,message:"ok",data:d(l.data)}):Response.json({code:502,message:l.message,data:{}},{status:502})}function d(s){return{list:s?.list?.map(e=>{let r=[{label:e?.new_ep?.index_show},{label:"\u8BC4\u5206",value:e?.rating?.score},{label:"\u64AD\u653E\u91CF",value:e?.stat?.view&&c(e.stat.view)},{label:"\u8FFD\u756A\u6570",value:e?.stat?.follow&&c(e.stat.follow)},{label:"\u6295\u5E01\u6570",value:e?.stat?.coin&&c(e.stat.coin)},{label:"\u5F39\u5E55\u6570",value:e?.stat?.danmaku&&c(e.stat.danmaku)}];return{nameCN:e.title,summary:e.summary,cover:e.cover,url:e.url,labels:r.filter(a=>a.label)}})??[],pageNumber:s.pn,pageSize:s.ps,total:s.total,totalPages:Math.ceil(s.total/s.ps)}}var f={1:"2",2:"4"},y={0:null,1:"1",2:"3",3:"2"};async function h(s,t){let{subjectType:e="1",uid:r,collectionType:a="0",pageNumber:o=1,pageSize:n=10}=s,i=r??t?.BGM;if(!i)return Response.json({code:400,message:"uid is required",data:{}},{status:400});let u=p({subject_type:f[e],type:y[a],limit:n,offset:(Number(o)-1)*Number(n)}),l=await fetch(`https://api.bgm.tv/v0/users/${i}/collections?${u}`,{headers:{"User-Agent":"yixiaojiu/bilibili-bangumi-component (https://github.com/yixiaojiu/bilibili-bangumi-component)"}}),m=await l.json();return l.ok?Response.json({code:200,message:"ok",data:j(m,{pageNumber:o,pageSize:n})}):Response.json({code:502,message:m.description},{status:500})}function j(s,t){return{list:s?.data?.map(r=>{let a=r?.subject,o=[{label:a?.eps&&`${a.eps}\u8BDD`},{label:"\u8BC4\u5206",value:a?.score},{label:"\u6392\u540D",value:a?.rank}];return{name:a?.name,nameCN:a?.name_cn,summary:a?.short_summary,cover:a?.images?.large,url:a?.id?`https://bgm.tv/subject/${a?.id}`:"https://bgm.tv/",labels:o.filter(n=>n.label)}})??[],...t,total:s.total,totalPages:Math.ceil(s.total/t.pageSize)}}var L="edge",P=["hkg1","hnd1","kix1","sin1"];async function N(s){let t=new URL(s.url),e=b(t);return isMock?t.pathname.endsWith("bilibili")?Response.json(mockDataMap.bilibili):Response.json(mockDataMap.bgm):t.pathname.endsWith("bilibili")?await g(e,process.env):t.pathname.endsWith("bgm")?await h(e,process.env):Response.json({code:404,message:"not found",data:{}},{status:404})}export{N as GET,P as preferredRegion,L as runtime};
